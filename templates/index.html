{% extends "layout.html" %}
{% block title %}Lesson Generator | BeaconSEL{% endblock %}
{% block content %}

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary">üß† SEL Lesson Generator</h1>
      <p class="lead text-muted">Create engaging lessons that combine academics with social-emotional learning</p>
    </div>

    <button id="voiceBtn" class="btn btn-outline-secondary mb-3">üé§ Voice Mode</button>

    <!-- Quick Lesson Starters Section -->
    <div class="card shadow-sm mb-4 bg-light">
      <div class="card-body">
        <h5 class="mb-3">üß™ Quick Lesson Starters</h5>
        <div class="d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTemplate('2nd', 'ELA', 'Main Idea', 'Empathy')">
            üìñ ELA + Empathy (2nd)
          </button>
          <button type="button" class="btn btn-outline-success btn-sm" onclick="loadTemplate('4th', 'Math', 'Fractions', 'Self-Regulation')">
            üî¢ Math + Self-Reg (4th)
          </button>
          <button type="button" class="btn btn-outline-warning btn-sm" onclick="loadTemplate('5th', 'Science', 'Ecosystems', 'Relationship Skills')">
            üî¨ Science + Relationships (5th)
          </button>
          <button type="button" class="btn btn-outline-dark btn-sm" onclick="loadTemplate('3rd', 'Social Studies', 'Community Rules', 'Responsible Decision-Making')">
            üèõÔ∏è History + Decisions (3rd)
          </button>
          <button type="button" class="btn btn-outline-info btn-sm" onclick="loadTemplate('1st', 'Math', 'Counting', 'Self-Awareness')">
            üßÆ Math + Self-Aware (1st)
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('6th', 'Science', 'Weather Patterns', 'Social Awareness')">
            üå¶Ô∏è Science + Social (6th)
          </button>
        </div>
        <small class="text-muted d-block mt-2">Click any button to auto-fill the form with a proven lesson combination. You can edit before generating!</small>
      </div>
    </div>

    <div class="card shadow-sm"></div>
      <div class="card-body p-4">
        <form method="POST">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="grade" class="form-label fw-semibold">üìö Grade Level</label>
              <select name="grade" id="grade" class="form-select">
                <option value="Kindergarten">Kindergarten</option>
                <option value="1st">1st Grade</option>
                <option value="2nd">2nd Grade</option>
                <option value="3rd">3rd Grade</option>
                <option value="4th">4th Grade</option>
                <option value="5th">5th Grade</option>
                <option value="6th">6th Grade</option>
                <option value="7th">7th Grade</option>
                <option value="8th">8th Grade</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="subject" class="form-label fw-semibold">üìñ Subject</label>
              <select name="subject" id="subject" class="form-select">
                <option value="Math">Mathematics</option>
                <option value="ELA">English Language Arts</option>
                <option value="Science">Science</option>
                <option value="Social Studies">Social Studies</option>
                <option value="History">History</option>
              </select>
            </div>

            <div class="col-12">
              <label for="topic" class="form-label fw-semibold">üéØ Academic Topic</label>
              <input type="text" name="topic" id="topic" class="form-control" placeholder="e.g., fractions, photosynthesis, American Revolution" required>
            </div>

            <div class="col-12">
              <label for="sel" class="form-label fw-semibold">‚ù§Ô∏è SEL Focus</label>
              <select name="sel" id="sel" class="form-select">
                <option value="Self-Awareness">Self-Awareness</option>
                <option value="Self-Management">Self-Management</option>
                <option value="Social Awareness">Social Awareness</option>
                <option value="Relationship Skills">Relationship Skills</option>
                <option value="Responsible Decision-Making">Responsible Decision-Making</option>
              </select>
            </div>
          </div>

          <div class="text-center mt-4">
            <button type="button" onclick="showPrompt()" class="btn btn-outline-secondary me-2">üëÅÔ∏è Preview Prompt</button>
            <button type="submit" name="action" value="generate" class="btn btn-warning">‚ú® Generate Lesson Plan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Prompt History Section -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">üìö Prompt History</h5>
      </div>
      <div class="card-body">
        {{ prompt_history_html|safe }}
      </div>
    </div>

    <!-- Prompt Preview/Edit Section -->
    <div id="promptSection" style="display: none;" class="card shadow-sm mt-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">üìù Generated Prompt</h5>
      </div>
      <div class="card-body">
        <form method="POST" id="promptForm">
          <textarea id="promptText" name="custom_prompt" rows="8" class="form-control mb-3" placeholder="Edit the prompt before generating..."></textarea>
          <div class="text-center">
            <button type="submit" name="action" value="generate_custom" class="btn btn-warning me-2">‚ú® Generate with Custom Prompt</button>
            <button type="button" onclick="hidePrompt()" class="btn btn-secondary">‚ùå Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function showPrompt() {
        const grade = document.getElementById('grade').value;
        const subject = document.getElementById('subject').value;
        const topic = document.getElementById('topic').value;
        const sel = document.getElementById('sel').value;

        if (!topic.trim()) {
          alert('Please enter an academic topic first.');
          return;
        }

        const prompt = `Design a comprehensive integrated lesson plan for ${grade} students on the topic of '${topic}' in ${subject}. Include an SEL focus on ${sel}. The lesson should include: a creative hook, clear learning objectives, direct instruction, an engaging activity or game, guided practice, reflection questions that connect to the SEL focus, and an exit slip. Make it detailed and practical for teachers to implement.`;

        document.getElementById('promptText').value = prompt;
        document.getElementById('promptSection').style.display = 'block';
        document.getElementById('promptText').focus();
      }

      function hidePrompt() {
        document.getElementById('promptSection').style.display = 'none';
      }

      function loadTemplate(grade, subject, topic, sel) {
        // Fill in all form fields with the template values
        document.querySelector("select[name='grade']").value = grade;
        document.querySelector("select[name='subject']").value = subject;
        document.querySelector("input[name='topic']").value = topic;
        document.querySelector("select[name='sel']").value = sel;

        // Smooth scroll to the form for better UX
        document.querySelector("form").scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Focus on the topic field so they can see it's filled
        document.querySelector("input[name='topic']").focus();

        // Optional: Show a brief success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
        successMsg.innerHTML = `
          <strong>‚úÖ Template Loaded!</strong> ${grade} grade ${subject} lesson on "${topic}" with ${sel} focus.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector("form").insertBefore(successMsg, document.querySelector("form").firstChild);

        // Auto-remove the success message after 3 seconds
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.remove();
          }
        }, 3000);
      }
    </script>

    {{ output|safe }}
    {{ action_buttons|safe }}
  </div>
</div>

<script>
const voiceBtn = document.getElementById('voiceBtn');
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

recognition.lang = 'en-US';
recognition.interimResults = false;

voiceBtn.addEventListener('click', () => {
  voiceBtn.textContent = "üé§ Listening...";
  recognition.start();
});

recognition.onresult = function(event) {
  const transcript = event.results[0][0].transcript.trim();

  if (!transcript) {
    alert("‚ö†Ô∏è No speech detected. Please try again.");
    return;
  }

  fetch('/voice_command', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ command: transcript })
  })
  .then(res => res.json())
  .then(data => {
    if (data.lesson) {
      const lessonDiv = document.createElement('div');
      lessonDiv.innerHTML = `
        <div class='card shadow-sm mt-4'>
          <div class='card-header bg-warning text-dark'>
            <h5 class='mb-0'>üé§ Voice-Generated Lesson Plan</h5>
          </div>
          <div class='card-body'>
            <div id="lesson-output" style='white-space: pre-wrap; line-height: 1.8; color: #333;'>${data.lesson}</div>
             <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyLesson()">üìã Copy to Clipboard</button>
          </div>
        </div>
        ${data.download_available ? `
        <div class="text-center mt-4 mb-4">
          <a href="/download/txt" class="btn btn-success me-2">üìÑ Download as TXT</a>
          <a href="/download/pdf" class="btn btn-warning">üìë Download as PDF</a>
        </div>
        ` : ''}
      `;
      document.body.appendChild(lessonDiv);
    } else {
      alert("‚ùå Error: " + (data.error || "Unknown error"));
    }
  });
};

recognition.onend = function() {
  voiceBtn.textContent = "üé§ Voice Mode";
};

function copyLesson() {
  const lessonText = document.getElementById("lesson-output").innerText;
  navigator.clipboard.writeText(lessonText)
    .then(() => {
      alert("‚úÖ Lesson copied to clipboard!");
    })
    .catch(err => {
      alert("‚ùå Failed to copy lesson.");
      console.error("Copy error:", err);
    });
}

function toggleCopilot() {
  const panel = document.getElementById("copilotPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function saveCopilotTip() {
  const content = document.getElementById("copilotContent").innerText;
  const grade = document.querySelector("select[name='grade']").value;
  const subject = document.querySelector("select[name='subject']").value;
  const topic = document.querySelector("input[name='topic']").value;
  const sel = document.querySelector("select[name='sel']").value;

  fetch('/save_copilot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ grade, subject, topic, sel, content })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("‚úÖ Copilot tip saved to journal!");
    } else {
      alert("‚ùå Error saving tip.");
    }
  });
}
</script>

{% endblock %}